-- ========================================
-- The KreOS 3.0 Skylark Color Settings
-- Written by kornichen
-- Lastly modified on 31st March 2015
-- Licensed under General Public License V3
-- ========================================

os.loadAPI("/system/apis/skylark")

local args = { ... }

if args[1] ~= "settings" then
	error("This has to be started from KreOS.")
end

local pages, buttons, labels, checkboxes, scrollbars, images, render, action = skylark.init()
local w, h = term.getSize()

local file = fs.open("/system/config/config", "r")
local data = file.readAll()
file.close()
local config = textutils.unserialize(data)
local cfgBgColor = config[2][6][1]

local function changeColorInFile(newColor)
	file = fs.open("/system/config/config", "r")
	data = file.readAll()
	file.close()
	config = textutils.unserialize(data)
	config[2][6][1] = newColor
	newData = textutils.serialize(config)
	fs.delete("/system/config/config")
	file = fs.open("/system/config/config", "w")
	file.write(newData)
	file.close()
end

pages:create("config_color", "Color Settings", true, colors.white, true)

buttons:create("btnCfgColorSettings", "config_color", true, 2, 2, "Settings", colors.cyan, colors.gray, function()
	pages:disable("config_color")
	error()
end)

labels:create("lbBgColorSelection", "config_color", true, 2, 5, "Background Color:", colors.black, colors.white)

local colorList = { 1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096, 8192, 16384, 32768 }
local x = 20
local text = "  "
local txtColor = colors.black

for i = 1, #colorList do
	if colorList[i] == cfgBgColor then
		text = "++"
	else
		text = "  "
	end
	if colorList[i] == 1 and cfgBgColor ~= 1 then
		text = "[]"
	end
	if colorList[i] == 128 or colorList[i] == 32768 then
		txtColor = colors.white
	else
		txtColor = colors.black
	end
	buttons:create("btnBgColorSelection" .. i, "config_color", true, x, 5, text, txtColor, colorList[i], function()
		changeColorInFile(colorList[i])
		cfgBgColor = colorList[i]
	end)
	x = x + 2
end

local function renderColorButtons()
	for i = 1, #colorList do
		if colorList[i] == cfgBgColor then
			text = "++"
		else
			text = "  "
		end
		if colorList[i] == 1 and cfgBgColor ~= 1 then
			text = "[]"
		end
		if colorList[i] == 128 or colorList[i] == 32768 then
			txtColor = colors.white
		else
			txtColor = colors.black
		end
		buttons:changeText("btnBgColorSelection" .. i, text)
		buttons:changeTxtColor("btnBgColorSelection" .. i, txtColor)
	end
end

while true do
	render:all(pages, buttons, labels, checkboxes, images)
	action:pullEvent(pages, buttons, checkboxes, images)
	renderColorButtons()
end