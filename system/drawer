-- ========================================
-- The KreOS 3.0 Skylark Drawer
-- Written by kornichen
-- Lastly modified on 1st April 2015
-- Licensed under General Public License V3
-- ========================================

os.loadAPI("/system/apis/skylark")

local pages, buttons, inputboxes, labels, checkboxes, scrollbars, images, render, action = skylark.init()
local w, h = term.getSize()

local function imageGetSize(image)
	local x = 0
	local y = #image
	for i = 1, y do
		if #image[i] > x then
			x = #image[i]
		end
	end
	return x, y
end

local function getBgColorFromFile()
	local file = fs.open("/system/config/config", "r")
	local data = file.readAll()
	file.close()
	local config = textutils.unserialize(data)
	return config[3][6][1]
end

local file = fs.open("/system/config/apps", "r")
local data = file.readAll()
file.close()
local apps = textutils.unserialize(data)

pages:create("drawer", "Home", true, getBgColorFromFile(), true)

buttons:create("btnDrawerSettings", "drawer", true, 2, 2, "Settings", colors.cyan, colors.gray, function()
	pages:disable("drawer")
	shell.run("/system/settings", "drawer")
	pages:enable("drawer")
	pages:changeBgColor("drawer", getBgColorFromFile())
end)

local time = textutils.formatTime(os.time(), false)
labels:create("lbTime", "drawer", true, w - string.len(time), 2, time, colors.cyan, colors.gray)

local page = 1
local appsIcons = {}
local temp = 1
local temp2 = 1
appsIcons[1] = {}
for i = 2, #apps do
	appsIcons[temp2][temp] = { apps[i][3], apps[i][4], apps[i][5] }
	temp = temp + 1
	if temp > 4 then
		temp = 1
		temp2 = temp2 + 1
		appsIcons[temp2] = {}
	end
end
local appsPages = #appsIcons

if appsPages > 1 then
	buttons:create("btnDrawerLast", "drawer", true, 2, h - 1, "<--", colors.black, colors.white, function()
		if page > 1 then
			page = page - 1
		end
	end)
	buttons:create("btnDrawerNext", "drawer", true, w - 3, h - 1, "-->", colors.black, colors.white, function()
		if page < appsPages then
			page = page + 1
		end
	end)
end

for j = 1, appsPages do
	local x = 1
	if #appsIcons[page] == 1 then
		x = (w / 2) - 3
	elseif #appsIcons[page] == 2 then
		x = (w / 2) - 6
	elseif #appsIcons[page] == 3 then
		x = (w / 2) - 12
	elseif #appsIcons[page] >= 4 then
		x = (w / 2) - 16
	end

	for i = 1, #appsIcons[j] do

		if j == page then
			local enabled = true
		else
			local enabled = false
		end
		local icon = paintutils.loadImage(appsIcons[j][i][2])

		images:create("imgApp" .. j .. i, "drawer", enabled, x, (h / 2) - (imageGetSize(icon) / 2) + 3, icon, function()
			if appsIcons[j][i][3] ~= false then
				pages:disable("drawer")
				shell.run(appsIcons[j][i][3])
				pages:enable("drawer")
			end
		end)
		x = x + 9
	end
end

local function activateCurrentPage()
	for j = 1, appsPages do
		for i = 1, #appsIcons[j] do
			if page == j then
				images:enable("imgApp" .. j .. i)
			else
				images:disable("imgApp" .. j .. i)
			end
			if page == 1 then
				buttons:disable("btnDrawerLast")
				buttons:enable("btnDrawerNext")
			elseif page == appsPages then
				buttons:disable("btnDrawerNext")
				buttons:enable("btnDrawerLast")
			else
				buttons:enable("btnDrawerNext")
				buttons:enable("btnDrawerLast")
			end
		end
	end
end

while true do
	activateCurrentPage()
	render:all(pages, buttons, inputboxes, labels, checkboxes, images)
	time = textutils.formatTime(os.time(), false)
	labels:changeText("lbTime", time)
	labels:changePosition("lbTime", w - string.len(time), 2)
	action:pullEvent(pages, buttons, inputboxes, checkboxes, images)
end